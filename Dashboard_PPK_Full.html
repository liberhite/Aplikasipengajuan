<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard PPK - Sistem Pengadaan</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  
  <!-- Navigation -->
  <nav class="bg-blue-600 text-white p-4">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-xl font-bold">Dashboard PPK</h1>
      <div id="userInfo" class="text-sm"></div>
    </div>
  </nav>

  <!-- Stats Cards -->
  <div class="container mx-auto p-6">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white p-6 rounded-lg shadow">
        <h3 class="text-gray-500 text-sm">Total Pengajuan</h3>
        <p id="statTotal" class="text-3xl font-bold text-blue-600">0</p>
      </div>
      <div class="bg-white p-6 rounded-lg shadow">
        <h3 class="text-gray-500 text-sm">Diproses</h3>
        <p id="statDiproses" class="text-3xl font-bold text-yellow-600">0</p>
      </div>
      <div class="bg-white p-6 rounded-lg shadow">
        <h3 class="text-gray-500 text-sm">Selesai</h3>
        <p id="statSelesai" class="text-3xl font-bold text-green-600">0</p>
      </div>
      <div class="bg-white p-6 rounded-lg shadow">
        <h3 class="text-gray-500 text-sm">Ditolak</h3>
        <p id="statDitolak" class="text-3xl font-bold text-red-600">0</p>
      </div>
    </div>

    <!-- Button Pengajuan Baru -->
    <button onclick="showFormPengajuan()" class="mb-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
      + Pengajuan Baru
    </button>

    <!-- Form Pengajuan (Hidden) -->
    <div id="formContainer" class="hidden bg-white p-6 rounded-lg shadow mb-6">
      <h2 class="text-xl font-bold mb-4">Form Pengajuan Baru</h2>
      <form id="formPengajuan" class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">Nomor Proses</label>
          <input type="text" id="nomorProses" readonly class="w-full p-2 border rounded bg-gray-100">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Nama Paket</label>
          <input type="text" id="namaPaket" required class="w-full p-2 border rounded">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Uraian Pekerjaan</label>
          <textarea id="uraianPekerjaan" required class="w-full p-2 border rounded" rows="3"></textarea>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Jenis Pengadaan</label>
            <select id="jenisPengadaan" required class="w-full p-2 border rounded">
              <option value="">Pilih...</option>
              <option>Barang</option>
              <option>Jasa Konsultansi</option>
              <option>Pekerjaan Konstruksi</option>
              <option>Jasa Lainnya</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">HPS (Rp)</label>
            <input type="number" id="hpsNominal" required class="w-full p-2 border rounded">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Jangka Waktu (hari)</label>
          <input type="number" id="jangkaWaktu" required class="w-full p-2 border rounded">
        </div>
        
        <!-- File Uploads -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Nota Dinas</label>
            <input type="file" id="fileNotaDinas" accept=".pdf" class="w-full p-2 border rounded">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">HPS</label>
            <input type="file" id="fileHps" accept=".pdf,.xlsx" class="w-full p-2 border rounded">
          </div>
        </div>

        <div class="flex gap-4">
          <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">
            Submit Pengajuan
          </button>
          <button type="button" onclick="hideFormPengajuan()" class="bg-gray-400 text-white px-6 py-2 rounded hover:bg-gray-500">
            Batal
          </button>
        </div>
      </form>
    </div>

    <!-- Tabel Riwayat -->
    <div class="bg-white p-6 rounded-lg shadow">
      <h2 class="text-xl font-bold mb-4">Riwayat Pengajuan</h2>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-100">
            <tr>
              <th class="p-3 text-left">No. Proses</th>
              <th class="p-3 text-left">Tanggal</th>
              <th class="p-3 text-left">Nama Paket</th>
              <th class="p-3 text-left">HPS</th>
              <th class="p-3 text-left">Status</th>
            </tr>
          </thead>
          <tbody id="tablePengajuan">
            <tr>
              <td colspan="5" class="p-4 text-center text-gray-400">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ⚠️ GANTI URL INI DENGAN URL DEPLOYMENT LU!
    const API_URL = 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec';
    
    // Mock user (nanti diganti dengan login real)
    const CURRENT_USER = {
      email: 'ppk.budi@kemenkeu.go.id',
      nama: 'Budi Santoso, S.E.',
      nip: '198501152010011002',
      satker: 'Direktorat Pengadaan'
    };

    // Load Dashboard
    async function loadDashboard() {
      try {
        const response = await fetch(`${API_URL}?action=getDashboardData&email=${CURRENT_USER.email}`);
        const result = await response.json();
        
        if (result.success) {
          // Update stats
          document.getElementById('statTotal').textContent = result.stats.total;
          document.getElementById('statDiproses').textContent = result.stats.diproses;
          document.getElementById('statSelesai').textContent = result.stats.selesai;
          document.getElementById('statDitolak').textContent = result.stats.ditolak;
          
          // Update table
          const tbody = document.getElementById('tablePengajuan');
          if (result.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400">Belum ada pengajuan</td></tr>';
          } else {
            tbody.innerHTML = result.data.map(item => `
              <tr class="border-b hover:bg-gray-50">
                <td class="p-3">${item.nomorProses}</td>
                <td class="p-3">${new Date(item.tanggal).toLocaleDateString('id-ID')}</td>
                <td class="p-3">${item.namaPaket}</td>
                <td class="p-3">Rp ${parseInt(item.hpsNominal).toLocaleString('id-ID')}</td>
                <td class="p-3">
                  <span class="px-2 py-1 rounded text-sm ${
                    item.status === 'Selesai' ? 'bg-green-100 text-green-800' :
                    item.status === 'Ditolak' ? 'bg-red-100 text-red-800' :
                    'bg-yellow-100 text-yellow-800'
                  }">
                    ${item.status}
                  </span>
                </td>
              </tr>
            `).join('');
          }
        }
      } catch (error) {
        console.error('Error loading dashboard:', error);
        alert('Gagal memuat data. Cek console untuk detail.');
      }
    }

    // Show/Hide Form
    function showFormPengajuan() {
      document.getElementById('formContainer').classList.remove('hidden');
      loadNextNomor();
    }

    function hideFormPengajuan() {
      document.getElementById('formContainer').classList.add('hidden');
      document.getElementById('formPengajuan').reset();
    }

    // Load Next Nomor
    async function loadNextNomor() {
      const response = await fetch(`${API_URL}?action=getNextNomor`);
      const result = await response.json();
      if (result.success) {
        document.getElementById('nomorProses').value = result.nomorProses;
      }
    }

    // Submit Form
    document.getElementById('formPengajuan').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = {
        nomorProses: document.getElementById('nomorProses').value,
        namaPaket: document.getElementById('namaPaket').value,
        uraianPekerjaan: document.getElementById('uraianPekerjaan').value,
        jenisPengadaan: document.getElementById('jenisPengadaan').value,
        hpsNominal: document.getElementById('hpsNominal').value,
        jangkaWaktu: document.getElementById('jangkaWaktu').value,
        emailPPK: CURRENT_USER.email,
        namaPPK: CURRENT_USER.nama,
        satker: CURRENT_USER.satker
      };

      try {
        const response = await fetch(`${API_URL}?action=submitPengajuan`, {
          method: 'POST',
          body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('Pengajuan berhasil disimpan!');
          hideFormPengajuan();
          loadDashboard();
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Gagal submit. Cek console.');
      }
    });

    // Display user info
    document.getElementById('userInfo').textContent = `${CURRENT_USER.nama} (${CURRENT_USER.nip})`;

    // Load on page load
    window.addEventListener('load', loadDashboard);
  </script>

</body>
</html>
